# Get current GCP project data
data "google_project" "current" {}

locals {
  name_prefix = "${var.project_name}-${var.environment}"
  
  common_labels = {
    project     = var.project_name
    environment = var.environment
    managed_by  = "terraform"
  }
}

# Storage bucket for conversation memory
resource "google_storage_bucket" "memory" {
  name          = "${local.name_prefix}-memory-${data.google_project.current.number}"
  location      = var.region
  force_destroy = true
  
  uniform_bucket_level_access = true
  
  versioning {
    enabled = var.environment == "prod"
  }
  
  lifecycle_rule {
    condition {
      age = var.environment == "prod" ? 90 : 30
    }
    action {
      type = "Delete"
    }
  }
  
  labels = local.common_labels
}

# Storage bucket for frontend static website
resource "google_storage_bucket" "frontend" {
  name          = "${local.name_prefix}-frontend-${data.google_project.current.number}"
  location      = var.region
  force_destroy = true
  
  uniform_bucket_level_access = true
  
  website {
    main_page_suffix = "index.html"
    not_found_page   = "index.html"
  }
  
  cors {
    origin          = ["*"]
    method          = ["GET", "HEAD", "OPTIONS"]
    response_header = ["*"]
    max_age_seconds = 3600
  }
  
  labels = local.common_labels
}

# Make frontend bucket public
resource "google_storage_bucket_iam_member" "frontend_public" {
  bucket = google_storage_bucket.frontend.name
  role   = "roles/storage.objectViewer"
  member = "allUsers"
}

# Storage bucket for Cloud Function source code
resource "google_storage_bucket" "function_source" {
  name          = "${local.name_prefix}-function-source-${data.google_project.current.number}"
  location      = var.region
  force_destroy = true
  
  uniform_bucket_level_access = true
  
  labels = local.common_labels
}

# Placeholder for function source
resource "google_storage_bucket_object" "function_source" {
  name   = "function-${var.environment}-source.zip"
  bucket = google_storage_bucket.function_source.name
  source = "${path.module}/../backend/function.zip"

  lifecycle {
    ignore_changes = [
      source,
      detect_md5hash,
    ]
  }
}

# Cloud Function (Gen 2) for the backend API
resource "google_cloudfunctions2_function" "api" {
  name     = "${local.name_prefix}-api"
  location = var.region
  
  build_config {
    runtime     = "python311"
    entry_point = "chat_handler"
    
    source {
      storage_source {
        bucket = google_storage_bucket.function_source.name
        object = google_storage_bucket_object.function_source.name
      }
    }
  }
  
  service_config {
    max_instance_count = var.function_max_instances
    min_instance_count = 0
    available_memory   = "${var.function_memory}Mi"
    timeout_seconds    = var.function_timeout
    
    environment_variables = {
      MEMORY_BUCKET     = google_storage_bucket.memory.name
      BEDROCK_MODEL_ID  = var.claude_model
      ANTHROPIC_API_KEY = var.anthropic_api_key
      ENVIRONMENT       = var.environment
    }
    
    ingress_settings               = "ALLOW_ALL"
    all_traffic_on_latest_revision = true
  }
  
  labels = local.common_labels

  depends_on = [
    google_storage_bucket_object.function_source
  ]
}

# Make Cloud Function publicly accessible
resource "google_cloudfunctions2_function_iam_member" "invoker" {
  project        = google_cloudfunctions2_function.api.project
  location       = google_cloudfunctions2_function.api.location
  cloud_function = google_cloudfunctions2_function.api.name
  role           = "roles/cloudfunctions.invoker"
  member         = "allUsers"
}
